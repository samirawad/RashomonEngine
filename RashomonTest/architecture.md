# Rashomon Engine Architecture Guide

## Overview
The Rashomon Engine is a Goal-Oriented Action Planning (GOAP) proof of concept built on the **Uniform Entity Container** model and the **Capability-Affordance Bridge**. 

In this model, NPCs do not possess "skills." Instead, they possess **Capabilities** (Tags) and consume **Affordances** (Activities) provided by other entities in the world.

---

## The Capability-Affordance Bridge
Every interaction in the world is a contract between a **Subject** (the NPC) and an **Object** (an Item, Location, or other NPC).

1.  **Affordances live on the Object**: An entity only affords activities to *others*. (e.g., An Apple affords "Eat", a Destination affords "WalkTo", a Merchant affords "Trade").
2.  **Capabilities live on the Subject**: An NPC provides the physical means to interact via **Tags** on their internal parts (e.g., a "Mouth" part tagged `Mouth`, "Feet" parts tagged `Feet`).
3.  **The Interaction Rule**: An NPC can only plan an activity if they possess the **Required Capability** defined by that activity's template.

---

## The Rule of Discovery
NPCs "find" their way through the world by matching their internal Capabilities against external Affordances:
1.  **Scan**: NPC scans their **Knowledge Graph** (Relationships and Children) for entities.
2.  **Filter**: NPC identifies which entities "offer" affordances.
3.  **Match**: The Planner verifies if the NPC has the **Tag** required to "unlock" that affordance.

---

## Activities as Scripted Scenes
Activities are **Centralized Orchestration Units** (Scenes) with empty **Roles**.
1.  **Late Binding**: An activity binds participants to roles (Initiator, Target, etc.) during planning.
2.  **Verifiable Contracts**: Before completion, an activity verifies that the Initiator still has the Capability and the Object still provides the Affordance.
3.  **Atomic Truth**: Social activities are shared instances; one object orchestrates all participants simultaneously.

---

## Simultaneous System Flow
... (rest of the file)

### 1. Entities (The Universal Atom)
The base class for everything in the world. 
- **Hierarchy**: Entities contain other entities (e.g., Bob contains a Stomach and an Inventory).
- **Affordances**: Entities "offer" Activities.
- **State & Tags**: Intrinsic (Tags) and Transient (States) properties define an entity.

### 2. Agents (NPCs as Time-Sliced Containers)
Specialized entities that manage a "Personal World" and own a **Brain Update Cycle**.
- **Non-Blocking Logic**: NPCs perform exactly one "slice" of an activity per world tick.
- **Queue-Based Execution**: NPCs maintain a queue of activities generated by the planner.

### 3. Activities (Scripted Contracts)
Activities are the "verbs" of the world, designed as **Verifiable Contracts** for multi-agent coordination.
- **Targeted States**: Activities use specific, targeted keys for preconditions (e.g., `Near(Alice)` instead of a generic `NearTarget`).
- **Verification Guards**: Before applying effects, an activity MUST verify that its physical and logical conditions are still met (e.g., "Is the Target still in range?").
- **Director Logic**: Orchestrates interactions between entities over time.
- **Atomic Physical Transfer**: Securely moves entities between hierarchies (e.g., `TradeActivity` swaps items).

### 4. The Planner (Discovery-Based)
The planner recursively searches the Knowledge Graph for entities that afford the activities needed to reach a targeted goal state.

---

## Simultaneous System Flow

The simulation operates on a **Parallel Heartbeat**:

1.  **World Tick**: The Global Clock increments.
2.  **Entity Tick**: All internal entities update their states.
3.  **NPC Thought Cycle**:
    - **Perception**: NPC checks if their goal is still valid.
    - **Verification**: Current activity checks if its contract is still valid.
    - **Execution Slice**: NPC performs exactly **one tick** of the current activity.
4.  **Contract Fulfillment**: Upon completion, guards are checked. If valid, effects are applied atomically. If invalid, the activity fails without applying effects.

---

## Project Structure

```text
RashomonTest/
├── Core/               
│   ├── Entity.cs       # Base Universal Atom
│   ├── Activity.cs     # Verifiable Contract
│   ├── NPC.cs          # Time-Sliced Agent
│   └── ...             
├── Activities/         # The Script Library
└── Program.cs          # Main Parallel Loop
```
